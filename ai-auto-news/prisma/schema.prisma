// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String   @id @default(uuid())
  email           String   @unique
  username        String   @unique
  passwordHash    String
  tier            String   @default("free")
  apiCallsTotal   Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  lastActiveAt    DateTime @default(now())
  isActive        Boolean  @default(true)
  isVerified      Boolean  @default(false)
  stripeCustomerId String? @unique
  tenantId        String?  @map("tenant_id")

  subscriptions    Subscription[]
  apiKeys          ApiKey[]
  usageEvents      UsageEvent[]
  analyticsEvents  AnalyticsEvent[]
  webhooks         Webhook[]
  tasks            Task[]
  auditLogs        AuditLog[]       @relation("ActorAuditLogs")
  customTopics     CustomTopic[]
  sessions         Session[]
  organizations    OrganizationMember[]
  invoices         Invoice[]
  referrals        Referral[]       @relation("Referrer")
  referredBy       Referral?        @relation("Referred")
  tenant           Tenant?          @relation(fields: [tenantId], references: [id])

  @@index([email])
  @@index([username])
  @@index([tier])
  @@index([tenantId])
  @@map("users")
}

model Tenant {
  id              String   @id @default(uuid())
  name            String
  slug            String   @unique
  customDomain    String?  @unique
  logoUrl         String?
  primaryColor    String?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  settings        Json     @default("{}")

  users           User[]
  organizations   Organization[]

  @@index([slug])
  @@map("tenants")
}

model Organization {
  id              String   @id @default(uuid())
  name            String
  slug            String   @unique
  tenantId        String   @map("tenant_id")
  tier            String   @default("free")
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  settings        Json     @default("{}")

  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  members         OrganizationMember[]

  @@index([tenantId])
  @@index([slug])
  @@map("organizations")
}

model OrganizationMember {
  id              String   @id @default(uuid())
  organizationId  String   @map("organization_id")
  userId          String   @map("user_id")
  role            String   @default("member")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([userId])
  @@map("organization_members")
}

model Post {
  id                String   @id @default(uuid())
  title             String
  slug              String   @unique
  content           String   @db.Text
  summary           String   @db.Text
  tags              Json
  category          String
  metaDescription   String   @db.Text
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  sourceReferences  Json?
  autoGenerated     Boolean  @default(false)
  publishedAt       DateTime?
  views             Int      @default(0)
  likes             Int      @default(0)

  @@index([slug])
  @@index([createdAt])
  @@index([category])
  @@index([publishedAt])
  @@map("posts")
}

model Subscription {
  id                    String   @id @default(uuid())
  userId                String   @map("user_id")
  tier                  String
  status                String
  currentPeriodStart    DateTime @map("current_period_start")
  currentPeriodEnd      DateTime @map("current_period_end")
  cancelAtPeriodEnd     Boolean  @default(false) @map("cancel_at_period_end")
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  stripeSubscriptionId  String?  @unique @map("stripe_subscription_id")
  stripePriceId         String?  @map("stripe_price_id")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("subscriptions")
}

model ApiKey {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  name         String
  keyHash      String   @unique @map("key_hash")
  keyPrefix    String   @map("key_prefix")
  scopes       Json
  callCount    Int      @default(0) @map("call_count")
  lastUsedAt   DateTime? @map("last_used_at")
  expiresAt    DateTime? @map("expires_at")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  usageEvents  UsageEvent[]

  @@index([userId])
  @@index([keyHash])
  @@map("api_keys")
}

model UsageEvent {
  id         String   @id @default(uuid())
  userId     String?  @map("user_id")
  apiKeyId   String?  @map("api_key_id")
  endpoint   String
  method     String
  statusCode Int      @map("status_code")
  durationMs Int      @map("duration_ms")
  tokensUsed Int?     @map("tokens_used")
  tier       String
  ipAddress  String?  @map("ip_address")
  createdAt  DateTime @default(now()) @map("created_at")

  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)
  apiKey ApiKey? @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@index([endpoint])
  @@map("usage_events")
}

model FeatureFlag {
  id               String   @id @default(uuid())
  name             String   @unique
  description      String   @db.Text
  enabledTiers     Json     @map("enabled_tiers")
  isGlobal         Boolean  @default(false) @map("is_global")
  rolloutPercent   Int      @default(0) @map("rollout_percent")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@index([name])
  @@map("feature_flags")
}

model AnalyticsEvent {
  id         String   @id @default(uuid())
  userId     String?  @map("user_id")
  sessionId  String?  @map("session_id")
  eventName  String   @map("event_name")
  properties Json
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([eventName])
  @@index([userId])
  @@index([createdAt])
  @@map("analytics_events")
}

model Webhook {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  url               String
  events            Json
  secret            String
  isActive          Boolean  @default(true) @map("is_active")
  deliveryCount     Int      @default(0) @map("delivery_count")
  failureCount      Int      @default(0) @map("failure_count")
  lastDeliveredAt   DateTime? @map("last_delivered_at")
  createdAt         DateTime @default(now()) @map("created_at")

  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  deliveries    WebhookDelivery[]

  @@index([userId])
  @@index([isActive])
  @@map("webhooks")
}

model WebhookDelivery {
  id          String   @id @default(uuid())
  webhookId   String   @map("webhook_id")
  event       String
  payload     Json
  statusCode  Int?     @map("status_code")
  response    String?  @db.Text
  attempts    Int      @default(0)
  status      String   @default("pending")
  createdAt   DateTime @default(now()) @map("created_at")
  deliveredAt DateTime? @map("delivered_at")

  webhook Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([status])
  @@map("webhook_deliveries")
}

model Task {
  id          String   @id @default(uuid())
  type        String
  payload     Json
  status      String   @default("pending")
  attempts    Int      @default(0)
  maxAttempts Int      @default(3) @map("max_attempts")
  error       String?  @db.Text
  priority    Int      @default(0)
  userId      String?  @map("user_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  scheduledAt DateTime @default(now()) @map("scheduled_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([scheduledAt])
  @@index([type])
  @@index([priority])
  @@map("tasks")
}

model AuditLog {
  id            String   @id @default(uuid())
  actorId       String   @map("actor_id")
  actorType     String   @map("actor_type")
  action        String
  resourceType  String   @map("resource_type")
  resourceId    String   @map("resource_id")
  details       Json
  ipAddress     String?  @map("ip_address")
  userAgent     String?  @map("user_agent")
  createdAt     DateTime @default(now()) @map("created_at")

  actor User @relation("ActorAuditLogs", fields: [actorId], references: [id], onDelete: Cascade)

  @@index([actorId])
  @@index([action])
  @@index([createdAt])
  @@index([resourceType])
  @@map("audit_log")
}

model CustomTopic {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  topic       String
  isActive    Boolean  @default(true) @map("is_active")
  weight      Int      @default(1)
  lastUsedAt  DateTime? @map("last_used_at")
  useCount    Int      @default(0) @map("use_count")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isActive])
  @@map("custom_topics")
}

model Session {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  token        String   @unique
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  expiresAt    DateTime @map("expires_at")
  createdAt    DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("sessions")
}

model Invoice {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  amount            Decimal  @db.Decimal(10, 2)
  currency          String   @default("usd")
  status            String
  description       String?  @db.Text
  invoiceNumber     String   @unique @map("invoice_number")
  dueDate           DateTime @map("due_date")
  paidAt            DateTime? @map("paid_at")
  stripeInvoiceId   String?  @unique @map("stripe_invoice_id")
  createdAt         DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("invoices")
}

model Referral {
  id              String   @id @default(uuid())
  referrerId      String   @map("referrer_id")
  referredId      String   @unique @map("referred_id")
  code            String   @unique
  status          String   @default("pending")
  rewardAmount    Decimal? @db.Decimal(10, 2) @map("reward_amount")
  rewardedAt      DateTime? @map("rewarded_at")
  createdAt       DateTime @default(now()) @map("created_at")

  referrer User @relation("Referrer", fields: [referrerId], references: [id], onDelete: Cascade)
  referred User @relation("Referred", fields: [referredId], references: [id], onDelete: Cascade)

  @@index([referrerId])
  @@index([code])
  @@map("referrals")
}

model Plugin {
  id              String   @id @default(uuid())
  name            String
  slug            String   @unique
  description     String   @db.Text
  version         String
  author          String
  authorUrl       String?  @map("author_url")
  iconUrl         String?  @map("icon_url")
  downloadUrl     String   @map("download_url")
  category        String
  tags            Json
  downloads       Int      @default(0)
  rating          Decimal? @db.Decimal(3, 2)
  ratingCount     Int      @default(0) @map("rating_count")
  isVerified      Boolean  @default(false) @map("is_verified")
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  installations PluginInstallation[]

  @@index([slug])
  @@index([category])
  @@map("plugins")
}

model PluginInstallation {
  id          String   @id @default(uuid())
  pluginId    String   @map("plugin_id")
  userId      String   @map("user_id")
  isActive    Boolean  @default(true) @map("is_active")
  config      Json     @default("{}")
  installedAt DateTime @default(now()) @map("installed_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  plugin Plugin @relation(fields: [pluginId], references: [id], onDelete: Cascade)

  @@unique([pluginId, userId])
  @@index([userId])
  @@map("plugin_installations")
}

model MetricSnapshot {
  id          String   @id @default(uuid())
  metricName  String   @map("metric_name")
  value       Decimal  @db.Decimal(20, 6)
  dimensions  Json     @default("{}")
  timestamp   DateTime @default(now())

  @@index([metricName, timestamp])
  @@map("metric_snapshots")
}
